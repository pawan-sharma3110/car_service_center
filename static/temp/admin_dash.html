<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Manage Appointments</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin_dash.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
        }

        .sidebar-heading {
            font-size: 1.5rem;
            padding: 10px;
        }

        .list-group-item {
            color: white;
        }

        .list-group-item:hover {
            background-color: #555;
        }

        .navbar {
            background-color: #343a40;
            color: white;
        }

        .table th,
        .table td {
            text-align: center;
            vertical-align: middle;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .close-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            cursor: pointer;
        }

        .register-btn {
            float: right;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="bg-dark border-right" id="sidebar-wrapper">
            <div class="sidebar-heading text-white">Admin Dashboard</div>
            <div class="list-group list-group-flush">
                <a href="./admin_dash.html" class="list-group-item list-group-item-action bg-dark">Appointments</a>
                <a href="./service.html" class="list-group-item list-group-item-action bg-dark">Services</a>
                <a href="./users.html" class="list-group-item list-group-item-action bg-dark">Users</a>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <button class="btn btn-primary" id="menu-toggle">
                    <img src="../media/menu-bar.png" alt="toggle button" width="20px">
                </button>
            </nav>

            <div class="container-fluid">
                <h2 class="mt-4">Manage Appointments</h2>

                <!-- Register New Appointment Button -->
                <a href="#" class="btn btn-success register-btn" data-toggle="modal" data-target="#createModal">Register New Appointment</a>

                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Appointment ID</th>
                            <th>Full Name</th>
                            <th>Service Name</th>
                            <th>Mobile Number</th>
                            <th>Total Cost</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="appointment-table">
                        <!-- Data will be populated dynamically with JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Appointment Modal -->
    <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Create New Appointment</h5>
                    <button type="button" class="close close-btn" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="form-group">
                            <label for="fullName">Full Name</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNo">Mobile Number</label>
                            <input type="text" class="form-control" id="phoneNo" required>
                        </div>
                        <div class="form-group">
                            <label for="service">Service</label>
                            <input type="text" class="form-control" id="service" required>
                        </div>
                        <div class="form-group">
                            <label for="totalCost">Total Cost</label>
                            <input type="number" class="form-control" id="totalCost" required>
                        </div>
                        <div class="form-group">
                            <label for="time">Appointment Time</label>
                            <input type="datetime-local" class="form-control" id="time" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- Edit Appointment Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Appointment</h5>
                <button type="button" class="close close-btn" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span> <!-- Red cross button -->
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="appointmentId">
                    
                    <!-- Status dropdown -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-control" id="status" required>
                            <option value="Unscheduled">Unscheduled</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </div>

                    <!-- 24-hour Date-Time Picker -->
                    <div class="mb-3">
                        <label for="time" class="form-label">Appointment Time</label>
                        <input type="datetime-local" class="form-control" id="time" required>
                    </div>

                    <button type="submit" class="btn btn-primary">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>



    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
   <script>
    
           
    $(document).ready(function () {
        $("#menu-toggle").click(function (e) {
                e.preventDefault();
                $("#wrapper").toggleClass("toggled");
            });
    // Fetch and display appointments on page load
    function fetchAppointments() {
        fetch("http://localhost:8080/appointments")
            .then(response => response.json())
            .then(data => {
                let appointmentRows = '';
                if (data.length === 0) {
                    appointmentRows = `<tr><td colspan="9" class="text-center">No appointments available</td></tr>`;
                } else {
                    data.forEach((appointment, key) => {
                        let services = JSON.parse(appointment.services || "[]");
                        let serviceNames = services.map(service => service.name).join(', ');

                        appointmentRows += `
                            <tr>
                                <td>${key + 1}</td>
                                <td>${appointment.id}</td>
                                <td>${appointment.full_name}</td>
                                <td>${serviceNames}</td>
                                <td>${appointment.phone_no}</td>
                                <td>${appointment.total_cost}â‚¹</td>
                                <td>${new Date(appointment.date).toLocaleString()}</td>
                                <td>${appointment.status}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm edit-appointment" data-id="${appointment.id}">Edit</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('appointment-table').innerHTML = appointmentRows;
            })
            .catch(error => {
                console.error("Error fetching appointments:", error);
                alert("Error fetching appointments: " + error.message);
            });
    }

    fetchAppointments();

    // Open edit modal
    $(document).on('click', '.edit-appointment', function () {
        var appointmentId = $(this).data('id');
        fetch(`http://localhost:8080/admin/appointment/${appointmentId}`)
            .then(response => response.json())
            .then(appointment => {
                $('#appointmentId').val(appointment.id);
                $('#status').val(appointment.status);
                $('#time').val(new Date(appointment.date).toISOString().slice(0, 16)); // Converts to 'YYYY-MM-DDTHH:mm'

                // Show the modal
                $('#editModal').modal('show');
            })
            .catch(error => {
                console.error("Error fetching appointment details:", error);
                alert("Error fetching appointment details: " + error.message);
            });
    });

    // Handle appointment update
    $("#editForm").submit(function (e) {
        e.preventDefault();

        var updatedAppointment = {
            status: $("#status").val(),
            date: $("#time").val()
        };

        fetch(`http://localhost:8080/admin/appointment/${$("#appointmentId").val()}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(updatedAppointment)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(() => {
            $("#editModal").modal('hide');
            fetchAppointments();
        })
        .catch(error => {
            console.error("Error updating appointment:", error);
            alert("Error updating appointment: " + error.message);
        });
    });
});

   </script>
</body>

</html>

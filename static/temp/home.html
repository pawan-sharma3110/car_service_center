<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Service & Washing Center</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="../css/home.css">
    <!-- <link rel="stylesheet" href="../css/admin_dash.css"> -->

</head>
<style>
    /* Ensure this CSS is included after any Bootstrap CSS for specificity */
    .profile-dropdown {
        position: relative;
        display: inline-block;
        margin-right: 90px;
        cursor: pointer;

    }

    .profile-dropdown .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background-color: #343a40;

        /* Match your sidebar background color */
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        z-index: 1000;
    }

    .profile-dropdown:hover .dropdown-menu {
        display: block;
        cursor: pointer;
    }

    .dropdown-menu a {
        color: #fff;
        /* Adjust text color as needed */
        text-decoration: none;
        display: block;
        padding: 10px;
        cursor: pointer;
    }

    .dropdown-menu a:hover {
        background-color: #4e88c2;
        /* Adjust hover color as needed */
    }
</style>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light my-nav  fixed-top">
        <a class="navbar-brand" href="./home.html">Washing Hub</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="./home.html">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./user_services.html">Service</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./booking.html">Appointment</a>
                </li>
            </ul>
            <!-- Profile Dropdown -->
            <div class="profile-dropdown">
                <img id="profilePicture" src="" alt="Profile Icon" width="60" height="60"
                    class="rounded-circle profile-icon">
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="./appointment.html" id="appointments">My Appointments</a>
                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#updateModal">Update Profile</a>
                    <a class="dropdown-item" href="#" id="logoutButton">Logout</a>
                </div>
            </div>

    </nav>

    <section class="hero">
        <div class="container">
            <h1>Welcome to Our Car Service & Washing Center</h1>
            <p>Your car deserves the best care and maintenance.</p>
            <a href="#services" class="btn btn-primary">Our Services</a>
        </div>
    </section>

    <section id="services" class="services">
        <div class="container">
            <div class="text-center mb-5">
                <h2>Our Services</h2>
                <p>We offer a wide range of car services and washing options.</p>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <img src="../media/3.jpg" height="233px" card-img-top" alt="Service 1">
                        <div class="card-body">
                            <h5 class="card-title">Car Washing</h5>
                            <p class="card-text">Professional car washing services to keep your car sparkling clean.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <img src="../media/beautiful-car-washing-service_23-2149212221.avif" class="card-img-top"
                            alt="Service 2">
                        <div class="card-body">
                            <h5 class="card-title">Car Detailing</h5>
                            <p class="card-text">Comprehensive car detailing to restore your car's original shine.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <img src="../media/oil.JPG" class="card-img-top" alt="Service 3">
                        <div class="card-body">
                            <h5 class="card-title">Oil Change</h5>
                            <p class="card-text">Quick and efficient oil change services to keep your engine running
                                smoothly.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="about" class="about">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <img src="../media/4.jpg" alt="About Us">
                </div>
                <div class="col-md-6">
                    <h2>About Us</h2>
                    <p>We are a team of experienced professionals dedicated to providing the best car services and
                        washing solutions. Our goal is to ensure your car remains in top condition and looks as good as
                        new.</p>
                    <p>With years of experience and a commitment to quality, we offer a range of services designed to
                        meet all your car care needs.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="testimonials" class="testimonials">
        <div class="container">
            <div class="text-center mb-5">
                <h2>Testimonials</h2>
                <p>See what our satisfied customers have to say.</p>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="testimonial">
                        <p>"Excellent service! My car looks brand new after the detailing. Highly recommend!"</p>
                        <h5>- John Doe</h5>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="testimonial">
                        <p>"Fast and efficient oil change. Great customer service and friendly staff."</p>
                        <h5>- Jane Smith</h5>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="testimonial">
                        <p>"Best car washing service in town. My car has never looked so clean."</p>
                        <h5>- Michael Brown</h5>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="contact" class="contact">
        <div class="container">
            <div class="text-center mb-5">
                <h2>Contact Us</h2>
                <p>Get in touch with us for any inquiries or to book a service.</p>
            </div>
            <div class="row">
                <div class="col-md-6 offset-md-3">
                    <form>
                        <div class="form-group">
                            <label for="name">Full Name</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" required placeholder="Your Email">
                        </div>
                        <div class="form-group">
                            <label for="message">Message</label>
                            <textarea class="form-control" id="message" rows="5" required
                                placeholder="Any inquiries or to book a service"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Update User Profile -->
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update User</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="updateForm" enctype="multipart/form-data">
                        <input type="hidden" id="updateUserId" name="user_id"> <!-- Hidden field for User ID -->

                        <div class="form-group">
                            <label for="updateFullName">Full Name</label>
                            <input type="text" class="form-control" id="updateFullName" name="full_name" required>
                        </div>

                        <div class="form-group">
                            <label for="updateEmail">Email</label>
                            <input type="email" class="form-control" id="updateEmail" name="email" required>
                        </div>

                        <div class="form-group">
                            <label for="updatePassword">Password</label>
                            <input type="password" class="form-control" id="updatePassword" name="password"
                                placeholder="Enter new password">
                            <small class="form-text text-muted">Leave this blank to keep the current password.</small>
                        </div>

                        <div class="form-group">
                            <label for="updatePhoneNo">Phone No</label>
                            <input type="text" class="form-control" id="updatePhoneNo" name="phone_no" maxlength="10"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="updateRole">Role</label>
                            <select class="form-control" id="updateRole" name="role" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>

                        <!-- Address Fields -->
                        <div class="form-group">
                            <label for="updateStreet">Street</label>
                            <input type="text" class="form-control" id="updateStreet" name="street" required>
                        </div>
                        <div class="form-group">
                            <label for="updateCity">City</label>
                            <input type="text" class="form-control" id="updateCity" name="city" required>
                        </div>
                        <div class="form-group">
                            <label for="updateState">State</label>
                            <input type="text" class="form-control" id="updateState" name="state" required>
                        </div>
                        <div class="form-group">
                            <label for="updateZipCode">Zip Code</label>
                            <input type="text" class="form-control" id="updateZipCode" name="zip_code" required>
                        </div>

                        <!-- Hidden Address JSON Field -->
                        <input type="hidden" id="addressJSON" name="address">

                        <div class="form-group">
                            <label for="updateProfileImage">Profile Image (max 3MB)</label>
                            <input type="file" class="form-control-file" id="updateProfilePicture"
                                name="profile_picture" accept="image/*">
                        </div>

                        <button type="submit" class="btn btn-primary">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="row">
                <!-- Footer Logo and Description -->
                <div class="col-md-4 mb-3">
                    <h5 class="text-uppercase">Car Service Center</h5>
                    <p>Providing top-notch car servicing and washing services with a commitment to excellence.</p>
                </div>
                <!-- Quick Links -->
                <div class="col-md-4 mb-3">
                    <h5 class="text-uppercase">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="./index.html" class="text-white">Home</a></li>
                        <li><a href="./login.html" class="text-white">Services</a></li>
                        <li><a href="#contact" class="text-white">Contact</a></li>
                    </ul>
                </div>
                <!-- Social Media Icons -->
                <div class="col-md-4 mb-3">
                    <h5 class="text-uppercase">Follow Us</h5>
                    <div>
                        <a href="#" class="text-white me-2"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <hr class="border-light">
            <p class="mb-0">&copy; 2024 Car Service Center. All Rights Reserved.</p>
        </div>
    </footer>
    <!-- Font Awesome Kit -->
    <!-- <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Function to load profile picture
        function loadProfilePicture() {
            const userId = getCookie("user_id"); // Fetch user ID from the cookie

            if (userId) {
                // Construct the URL to fetch the profile picture
                const imageUrl = `/profile-picture?user_id=${userId}`; // Same port, API call
                const profileImageElement = document.querySelector('.profile-icon');

                // Set the src of the img element
                profileImageElement.src = imageUrl;

                profileImageElement.onerror = function () {
                    // Optional: Fallback if no profile picture is found
                    profileImageElement.src = "../media/user-sign-icon2.jpg";
                };
            } else {
                console.log("User ID not found in cookies.");
            }
        }
        loadProfilePicture();

        // Logout functionality
        $('#logoutButton').click(function (e) {
            e.preventDefault(); // Prevent default link behavior

            fetch('http://localhost:8080/user/logout', { // Ensure the endpoint matches your backend route
                method: 'POST', // Use POST, GET, or DELETE based on your backend API
                credentials: 'include', // Ensure cookies are included for authentication
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        // If logout is successful, redirect to login page or homepage
                        window.location.href = '../index.html'; // Adjust the redirect path as needed
                    } else {
                        alert('Logout failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                });
        });


        // Helper function to get the user ID from cookies
        function getCookie(name) {
            let cookieArr = document.cookie.split(";");

            for (let i = 0; i < cookieArr.length; i++) {
                let cookiePair = cookieArr[i].split("=");
                if (name === cookiePair[0].trim()) {
                    return decodeURIComponent(cookiePair[1]);
                }
            }
            return null;
        }

        // Fetch token from cookies
        function getToken() {
            const name = "token=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookies = decodedCookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }
            return null;
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Triggered when the Update Profile button is clicked
            document.querySelector('.dropdown-item[data-target="#updateModal"]').addEventListener('click', function () {
                // Assume we have the user ID stored somewhere, or you can pass it dynamically
                var userId = getCookie("user_id"); // Replace this with dynamic value if necessary

                // Fetch user data from the server
                fetch(`/user/profile/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Populate form fields with the fetched user data
                        document.getElementById('updateUserId').value = data.id;
                        document.getElementById('updateFullName').value = data.full_name;
                        document.getElementById('updateEmail').value = data.email;
                        // Password field is left blank intentionally
                        document.getElementById('updatePassword').value = '';
                        document.getElementById('updatePhoneNo').value = data.phone_no;
                        document.getElementById('updateRole').value = data.role;
                        document.getElementById('updateStreet').value = data.address.street;
                        document.getElementById('updateCity').value = data.address.city;
                        document.getElementById('updateState').value = data.address.state;
                        document.getElementById('updateZipCode').value = data.address.zip_code;
                        // Reset profile picture input
                        document.getElementById('updateProfilePicture').value = '';
                    })
                    .catch(error => console.error('Error fetching user profile:', error));
            });

            document.getElementById("updateForm").addEventListener("submit", function (event) {
                event.preventDefault(); // Prevent the default form submission

                // Serialize address fields into JSON
                var address = {
                    street: document.getElementById('updateStreet').value.trim(),
                    city: document.getElementById('updateCity').value.trim(),
                    state: document.getElementById('updateState').value.trim(),
                    zip_code: document.getElementById('updateZipCode').value.trim()
                };

                // Validate address fields if necessary
                // Example: Ensure zip code is numeric
                if (!/^\d{6}(-\d{6})?$/.test(address.zip_code)) {
                    alert("Please enter a valid zip code.");
                    return;
                }

                // Set the serialized address JSON
                document.getElementById('addressJSON').value = JSON.stringify(address);

                // Validate profile picture size (max 3MB)
                var profilePictureInput = document.getElementById('updateProfilePicture');
                if (profilePictureInput.files.length > 0) {
                    var file = profilePictureInput.files[0];
                    if (file.size > 3 * 1024 * 1024) { // 3MB in bytes
                        alert("Profile picture must be less than 3MB.");
                        return;
                    }
                }

                // Get the form data
                var formData = new FormData(this);

                var userId = document.getElementById('updateUserId').value;

                // Send the form data to the server
                fetch(`/user/update-profile/${userId}`, {
                    method: 'POST', // Or PUT if using that
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,

                    },
                    body: formData,
                })
                    .then(response => {
                        if (response.ok) {
                            return response.text(); // Handle success response
                        } else {
                            return response.text().then(text => { throw new Error(text) });
                        }
                    })
                    .then(data => {
                        alert("Profile updated successfully!");
                        location.reload(); // Reload the page or update the UI accordingly
                    })
                    .catch(error => {
                        console.error('Error updating profile:', error);
                        alert(`Error updating profile: ${error.message}`);
                    });
            });
        });


    </script>

</body>

</html>